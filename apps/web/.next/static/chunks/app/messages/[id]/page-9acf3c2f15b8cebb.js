(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[299],{3940:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>F});var t=r(9611),a=r(8011),n=r(8670),l=r(6057),i=r(6375),o=r(9191),d=r(4133),c=r(8569),u=r(8518),m=r(6551),x=r(715),h=r(946),v=r(9622),f=r(3550),g=r(1762),N=r(4593);function j(e){let{isOpen:s,onClose:r,members:l,channelName:i}=e,[o,d]=(0,a.useState)(""),c=(0,a.useMemo)(()=>{if(!o.trim())return l;let e=o.toLowerCase();return l.filter(s=>{var r,t,a,n;return null!=(a=null==(r=s.username)?void 0:r.toLowerCase().includes(e))&&a||null!=(n=null==(t=s.email)?void 0:t.toLowerCase().includes(e))&&n})},[l,o]);return(0,t.jsx)(g.lG,{open:s,onOpenChange:r,children:(0,t.jsxs)(g.Cf,{className:"sm:max-w-[500px]",children:[(0,t.jsx)(g.c7,{children:(0,t.jsxs)(g.L3,{className:"flex items-center gap-2",children:[(0,t.jsx)(n.A,{className:"w-5 h-5"}),"Members of #",i]})}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(h.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),(0,t.jsx)(f.p,{placeholder:"Search members...",value:o,onChange:e=>d(e.target.value),className:"pl-10 pr-10"}),o&&(0,t.jsx)(u.$,{variant:"ghost",size:"sm",onClick:()=>{d("")},className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-7 w-7 p-0 hover:bg-muted",children:(0,t.jsx)(v.A,{className:"w-4 h-4"})})]}),(0,t.jsx)("div",{className:"max-h-[400px] overflow-y-auto space-y-3",children:0===c.length?(0,t.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:o?"No members found matching your search.":"No members in this channel."}):c.map(e=>{var s;return(0,t.jsxs)("div",{className:"flex items-center space-x-3 p-3 rounded-lg border bg-card hover:bg-accent/50 transition-colors",children:[(0,t.jsxs)(N.eu,{className:"w-10 h-10",children:[(0,t.jsx)(N.BK,{src:e.avatar,alt:e.username||"User"}),(0,t.jsx)(N.q5,{children:((null==(s=e.username)?void 0:s.charAt(0))||"U").toUpperCase()})]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"font-medium text-sm truncate",children:e.username||"Unknown User"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground truncate",children:e.email||"No email"})]})]},e.id)})}),(0,t.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t",children:[(0,t.jsxs)("span",{className:"text-sm text-muted-foreground",children:[c.length," of ",l.length," members"]}),(0,t.jsx)(u.$,{variant:"outline",onClick:r,children:"Close"})]})]})]})})}var b=r(8572),p=r(6796),w=r(2039),y=r(2541),C=r(338);function S(e){let[s,r]=(0,a.useState)(!1),h=(0,p.useRouter)(),{removeConversation:v}=(0,w.w)(),{leaveConversation:f}=(0,y.Us)(),g=e.currentUserId===e.ownerId,N=(0,b.Hy)({onSuccess:()=>{let s=e.isGroup?"group":"direct";v(e.id,s);try{f(e.id)}catch(e){}C.oR.success("Successfully left the conversation"),h.push("/messages")},onError:()=>{C.oR.error("Failed to leave conversation. Please try again.")}}),S=(0,b.t7)({onSuccess:()=>{let s=e.isGroup?"group":"direct";v(e.id,s);try{f(e.id)}catch(e){}C.oR.success("Conversation deleted successfully"),h.push("/messages")},onError:()=>{C.oR.error("Failed to delete conversation. Please try again.")}});return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between p-chat-outer bg-background border-b border-t border-chat-border",children:[(0,t.jsxs)(x.rI,{children:[(0,t.jsx)(x.ty,{asChild:!0,children:(0,t.jsx)(u.$,{variant:"ghost",className:"h-auto p-0 hover:bg-transparent focus:bg-transparent",children:(0,t.jsxs)("div",{className:"flex items-center space-x-3 cursor-pointer hover:bg-accent/50 rounded-lg p-2 transition-colors",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"font-medium text-foreground",children:"#".concat(e.name)}),e.isGroup?(0,t.jsxs)("div",{className:"flex items-center space-x-1 text-sm text-muted-foreground",children:[(0,t.jsx)(n.A,{className:"w-3 h-3"}),(0,t.jsxs)("span",{className:"font-normal",children:[e.participantCount," members"]})]}):(0,t.jsx)("p",{className:"text-sm text-chat-accent font-normal",children:e.isOnline?"Online":"Offline"})]}),(0,t.jsx)(l.A,{className:"w-4 h-4 text-muted-foreground"})]})})}),(0,t.jsxs)(x.SQ,{align:"start",className:"w-56",children:[(0,t.jsxs)(x._2,{onClick:()=>{r(!0)},children:[(0,t.jsx)(i.A,{className:"mr-2 h-4 w-4"}),(0,t.jsx)("span",{children:"View members"})]}),(0,t.jsx)(x.mB,{}),g?(0,t.jsxs)(x._2,{onClick:()=>{let s=e.name;confirm(e.isGroup?'Are you sure you want to delete the group conversation "#'.concat(s,'"? This action cannot be undone and all members will lose access to this conversation.'):'Are you sure you want to delete the direct message with "'.concat(s,'"? This action cannot be undone.'))&&S.mutate(e.id)},className:"text-red-600 focus:text-red-600",disabled:S.isPending,children:[(0,t.jsx)(o.A,{className:"mr-2 h-4 w-4"}),(0,t.jsx)("span",{children:S.isPending?"Deleting...":"Delete conversation"})]}):(0,t.jsxs)(x._2,{onClick:()=>{confirm("Are you sure you want to leave this conversation?")&&N.mutate(e.id)},className:"text-orange-600 focus:text-orange-600",disabled:N.isPending,children:[(0,t.jsx)(d.A,{className:"mr-2 h-4 w-4"}),(0,t.jsx)("span",{children:N.isPending?"Leaving...":"Leave conversation"})]})]})]}),(0,t.jsx)("div",{className:"flex items-center space-x-2",children:(0,t.jsx)(m.Bc,{children:(0,t.jsxs)(m.m_,{children:[(0,t.jsx)(m.k$,{asChild:!0,children:(0,t.jsx)(u.$,{variant:"ghost",size:"sm",className:"h-9 w-9 p-0 hover:bg-chat-accent/10 cursor-not-allowed",children:(0,t.jsx)(c.A,{className:"w-4 h-4 text-muted-foreground"})})}),(0,t.jsx)(m.ZI,{children:(0,t.jsx)("p",{children:"Upcomming feature"})})]})})})]}),(0,t.jsx)(j,{isOpen:s,onClose:()=>r(!1),members:e.members||[],channelName:e.name})]})}function E(e){var s,r,a,n;let{message:l,isGroup:i,userId:o}=e;return l.senderId==o?(0,t.jsx)("div",{className:"flex justify-end mb-chat-gutter",children:(0,t.jsxs)("div",{className:"max-w-xs lg:max-w-md",children:[(0,t.jsx)("div",{className:"bg-chat-primary text-white rounded-chat px-4 py-2",children:(0,t.jsx)("p",{className:"break-words font-normal",children:l.text})}),(0,t.jsx)("div",{className:"flex justify-end mt-1",children:(0,t.jsx)("span",{className:"text-xs text-gray-500 font-normal",children:new Date(l.createdAt).toLocaleString()})})]})}):(0,t.jsxs)("div",{className:"flex items-start mb-chat-gutter",children:[i&&(0,t.jsxs)(N.eu,{className:"w-8 h-8 mr-2 flex-shrink-0",children:[(0,t.jsx)(N.BK,{src:l.senderAvatar}),(0,t.jsx)(N.q5,{className:"bg-chat-primary text-white",children:null!=(a=null==(r=l.senderName)||null==(s=r[0])?void 0:s.toUpperCase())?a:"A"})]}),(0,t.jsxs)("div",{className:"max-w-xs lg:max-w-md",children:[i&&(0,t.jsx)("p",{className:"text-sm font-medium text-foreground mb-1",children:null!=(n=l.senderName)?n:"Sender"}),(0,t.jsx)("div",{className:"bg-card border border-chat-border rounded-chat px-4 py-2",children:(0,t.jsx)("p",{className:"text-card-foreground break-words font-normal",children:l.text})}),(0,t.jsx)("div",{className:"flex justify-start mt-1",children:(0,t.jsx)("span",{className:"text-xs text-gray-500 font-normal",children:new Date(l.createdAt).toLocaleString()})})]})]})}var A=r(6619);function I(e){let{isGroup:s}=e;return(0,t.jsx)("div",{className:"space-y-0",children:Array.from({length:6}).map((e,r)=>r%3==0?(0,t.jsx)("div",{className:"flex justify-end mb-4",children:(0,t.jsxs)("div",{className:"max-w-xs lg:max-w-md",children:[(0,t.jsxs)("div",{className:"bg-gray-200 rounded-lg rounded-br-sm px-4 py-2",children:[(0,t.jsx)(A.E,{className:"h-4 w-32 mb-1"}),r%2==0&&(0,t.jsx)(A.E,{className:"h-4 w-24"})]}),(0,t.jsx)("div",{className:"flex justify-end mt-1",children:(0,t.jsx)(A.E,{className:"h-3 w-12"})})]})},r):(0,t.jsxs)("div",{className:"flex items-start mb-4",children:[s&&(0,t.jsx)(A.E,{className:"w-8 h-8 rounded-full mr-2 flex-shrink-0"}),(0,t.jsxs)("div",{className:"max-w-xs lg:max-w-md",children:[s&&(0,t.jsx)(A.E,{className:"h-4 w-20 mb-1"}),(0,t.jsxs)("div",{className:"bg-gray-100 border border-gray-200 rounded-lg rounded-bl-sm px-4 py-2",children:[(0,t.jsx)(A.E,{className:"h-4 w-40 mb-1"}),r%3==1&&(0,t.jsx)(A.E,{className:"h-4 w-28"})]}),(0,t.jsx)("div",{className:"flex justify-start mt-1",children:(0,t.jsx)(A.E,{className:"h-3 w-12"})})]})]},r))})}var k=r(6781),R=r(7546),L=r(9240);function O(e){var s;let{onSendMessage:r,onStartTyping:n,onStopTyping:l,isConnected:i=!0,disabled:o=!1}=e,d=(0,a.useRef)(null),c=()=>{var e;let s=(null==(e=d.current)?void 0:e.value)||"";s.trim()&&i&&!o&&(r(s.trim()),d.current&&(d.current.value=""))};return(0,t.jsxs)("div",{className:"p-chat-outer bg-background border-t border-chat-border",children:[!i&&(0,t.jsx)("div",{className:"mb-2 text-sm text-amber-600 bg-amber-50 border border-amber-200 rounded-chat px-3 py-1 font-normal",children:"Not connected to chat server"}),(0,t.jsxs)("div",{className:"h-[40px] flex items-center space-x-3",children:[(0,t.jsx)("div",{className:"flex-1 w-full",children:(0,t.jsxs)("div",{className:"h-[40px] flex items-center space-x-2 bg-input-background border border-chat-border rounded-chat px-3 py-2 w-full focus-within:border-chat-primary transition-colors",children:[(0,t.jsx)(u.$,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 hover:bg-chat-accent/10 cursor-not-allowed",children:(0,t.jsx)(k.A,{className:"w-4 h-4 text-muted-foreground"})}),(0,t.jsx)("input",{type:"text",ref:d,placeholder:o?"Chat disabled":i?"Type a message...":"Connecting...",onChange:e=>{e.target.value},onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),c())},disabled:o||!i,className:"flex-1 bg-transparent outline-none resize-none disabled:cursor-not-allowed disabled:text-gray-400 font-normal text-base"}),(0,t.jsx)(u.$,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 hover:bg-chat-accent/10 cursor-not-allowed",children:(0,t.jsx)(R.A,{className:"w-4 h-4 text-muted-foreground"})})]})}),(0,t.jsx)(u.$,{onClick:c,disabled:!((null==(s=d.current)?void 0:s.value)||"").trim()||o||!i,className:"h-10 w-10 p-0 bg-chat-primary hover:bg-chat-secondary disabled:bg-gray-300 rounded-chat",children:(0,t.jsx)(L.A,{className:"w-4 h-4"})})]})]})}var M=r(9537),U=r(6245);let K=a.forwardRef((e,s)=>{let{className:r,children:a,...n}=e;return(0,t.jsxs)(M.bL,{ref:s,className:(0,U.cn)("relative overflow-hidden",r),...n,children:[(0,t.jsx)(M.LM,{className:"h-full w-full rounded-[inherit]",children:a}),(0,t.jsx)(P,{}),(0,t.jsx)(M.OK,{})]})});K.displayName=M.bL.displayName;let P=a.forwardRef((e,s)=>{let{className:r,orientation:a="vertical",...n}=e;return(0,t.jsx)(M.VM,{ref:s,orientation:a,className:(0,U.cn)("flex touch-none select-none transition-colors","vertical"===a&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===a&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",r),...n,children:(0,t.jsx)(M.lr,{className:"relative flex-1 rounded-full bg-border"})})});P.displayName=M.VM.displayName;var T=r(346),_=r(8914);let z=async(e,s)=>{let{data:r}=await _.u.get("/messages/conversation/".concat(e),{params:s});return r};var D=r(920),G=r(875),$=r(120);let B=(0,G.v)()((0,$.Zr)(e=>({conversations:{},activeConversationId:null,loading:!1,upsertMessageToConversation:(s,r)=>e(e=>{let t=e.conversations[s]||[],a=t.findIndex(e=>e.id===r.id);if(-1===a)return{conversations:{...e.conversations,[s]:[...t,r]}};{let n=[...t];return n[a]=r,{conversations:{...e.conversations,[s]:n}}}}),addMessageToConversation:(s,r)=>e(e=>({conversations:{...e.conversations,[s]:[...e.conversations[s]||[],r]}})),clearConversationMessages:s=>e(e=>({conversations:{...e.conversations,[s]:[]}})),reset:()=>e({conversations:{},activeConversationId:null,loading:!1}),setActiveConversation:s=>e({activeConversationId:s})}),{name:"chat-store",partialize:e=>({activeConversationId:e.activeConversationId}),storage:(0,$.KU)(()=>localStorage)})),F=()=>{var e;let{user:s,conversationId:r,currentConversation:n,conversationData:l,memberCount:i,containerRef:o,mainRef:d,chats:c,chatsLoading:u,handleSendMessage:m,isConnected:x,connectionState:h}=(()=>{let{data:e}=(0,D.sg)(),{data:s}=(0,D.sg)(),{screenHeight:r,isOverFlow:t,updateOverflow:n}=(e=>{let[s,r]=(0,a.useState)(720),[t,n]=(0,a.useState)(!1),[l,i]=(0,a.useState)(!1);(0,a.useEffect)(()=>{i(!0);let e=()=>{r(window.innerHeight)};return r(window.innerHeight),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]);let o=e=>{e>s-210?n(!0):e<s-210&&n(!1)};return l?{screenHeight:s,isOverFlow:t,updateOverflow:o}:{screenHeight:720,isOverFlow:!1,updateOverflow:o}})(720),{conversationId:l,currentConversation:i,connectionState:o}=(()=>{var e;let s=(0,p.useParams)(),r=(0,p.useRouter)(),{groupConversations:t,directConversations:n,currentConversation:l,setCurrentConversation:i}=(0,w.w)(),{connectionState:o,joinConversation:d,leaveConversation:c}=(0,y.Us)(),u=null!=(e=s.id)?e:void 0,m=(0,a.useMemo)(()=>{if(u)return t.find(e=>e.id===u)||n.find(e=>e.id===u)},[u,t,n]),x=(0,a.useRef)(void 0),h=(0,a.useRef)(void 0);(0,a.useEffect)(()=>{if(u){if(!m){h.current!==u&&(h.current=u,r.replace("/messages"));return}x.current!==m.id&&(x.current=m.id,i(m))}},[u,m,r,i]);let v=(0,a.useRef)(void 0),f=(0,a.useRef)(void 0),g=(0,a.useRef)(!1);return(0,a.useEffect)(()=>{if(o!==y.KN.CONNECTED)return;let e=null==l?void 0:l.id,s=v.current;if(s!==e){if(s&&s!==e&&!g.current){try{g.current=!0,f.current=e,c(String(s))}catch(e){}return}if(!s&&e&&!g.current)try{d(String(e)),v.current=e}catch(e){}}},[o,null==l?void 0:l.id,d,c]),(0,a.useEffect)(()=>{let e=e=>{let s=e.detail,r=v.current;if(!g.current||!r||(null==s?void 0:s.conversationId)!==r)return;g.current=!1,v.current=void 0;let t=f.current;if(f.current=void 0,o===y.KN.CONNECTED&&t)try{d(String(t)),v.current=t}catch(e){}};return window.addEventListener("ws-conversation-leave-ack",e),()=>window.removeEventListener("ws-conversation-leave-ack",e)},[o,d]),{conversationId:u,currentConversation:l,connectionState:o}})(),{chats:d,chatsLoading:c}=(e=>{let{data:s,isLoading:r}=((e,s,r)=>(0,T.I)({queryKey:["messages",e,void 0],queryFn:()=>z(e,void 0),enabled:!!e,...void 0}))(e),{addMessageToConversation:t,conversations:n}=B(),l=(0,a.useMemo)(()=>e&&n[e]||[],[n,e]);return{chats:[...(0,a.useMemo)(()=>Array.isArray(null==s?void 0:s.data)?s.data.map(s=>{var r,t,a,n;return{id:String(null!=(r=s.id)?r:""),conversationId:String(null!=(a=null!=(t=s.conversationId)?t:e)?a:""),createdAt:s.createdAt?new Date(s.createdAt).toISOString():new Date().toISOString(),...void 0!==s.fileName&&{fileName:s.fileName},...void 0!==s.senderAvatar&&{senderAvatar:s.senderAvatar},senderId:String(null!=(n=s.senderId)?n:""),...void 0!==s.senderName&&{senderName:s.senderName},...void 0!==s.text&&{text:s.text},...void 0!==s.url&&{url:s.url}}}):[],[null==s?void 0:s.data,e]),...l],chatsLoading:r,addMessageToConversation:t}})(l),{conversationData:u,conversationLoading:m,memberCount:x}=(e=>{let{data:s,isLoading:r}=(0,b.Pp)(e,{enabled:!!e}),t=(0,a.useMemo)(()=>(null==s?void 0:s.members)?s.members.length:0,[null==s?void 0:s.members]);return{conversationData:s,conversationLoading:r,memberCount:t}})(l),{containerRef:h,mainRef:v,scrollToBottom:f,scrollToBottomOnUpdate:g}=(()=>{let e=(0,a.useRef)(null),s=(0,a.useRef)(null);return{containerRef:e,mainRef:s,scrollToBottom:()=>{var r,t;null==(r=e.current)||r.scrollIntoView({behavior:"smooth",block:"start"}),null==(t=s.current)||t.scrollIntoView({behavior:"smooth",block:"start"})},scrollToBottomOnUpdate:()=>{var e;null==(e=s.current)||e.scrollIntoView({behavior:"smooth"})}}})(),{formData:N,setFormData:j}=(()=>{let[e,s]=(0,a.useState)({message:""}),[r,t]=(0,a.useState)(!1),[n,l]=(0,a.useState)(""),[i,o]=(0,a.useState)(null),[d,c]=(0,a.useState)("");return(0,a.useEffect)(()=>{r&&(C.oR.warn(n),l(""),t(!1))},[r,n]),(0,a.useEffect)(()=>()=>{o(null),c(""),s({message:""}),t(!1),l("")},[]),{formData:e,setFormData:s,noti:r,setNoti:t,message:n,setMessage:l,file:i,setFile:o,fileName:d,setFileName:c}})(),S=((e,s,r,t)=>{let{sendMessage:n,isConnected:l,error:i}=(0,y.Us)(),o=(0,a.useCallback)(async a=>{if((null==s?void 0:s.id)&&""!==a&&e&&l())try{n(e,a),r({message:""}),t()}catch(e){C.oR.error("Failed to send message")}else l()||C.oR.warn("Not connected to chat server")},[null==s?void 0:s.id,e,l,n,r,t]);return(0,a.useEffect)(()=>{i&&C.oR.error("WebSocket Error: ".concat(i))},[i]),{handleSendMessage:o,isConnected:l(),error:i}})(l,e,j,f);return(e=>{let{upsertMessageToConversation:s}=B();(0,a.useEffect)(()=>{let r=r=>{let t=r.detail;if(e&&String(t.conversationId)===String(e)){let r={id:String(t.id),conversationId:String(t.conversationId),senderId:String(t.senderId),...void 0!==t.senderName&&{senderName:t.senderName},...void 0!==t.senderAvatar&&{senderAvatar:t.senderAvatar},...void 0!==t.text&&{text:t.text},createdAt:t.createdAt,...void 0!==t.url&&{url:t.url},...void 0!==t.fileName&&{fileName:t.fileName}};s(String(e),r)}};return window.addEventListener("chat-message",r),()=>{window.removeEventListener("chat-message",r)}},[e,s])})(l),(0,a.useEffect)(()=>{void 0!==d&&(null==d?void 0:d.length)&&f()},[null==d?void 0:d.length,f]),(0,a.useEffect)(()=>{g()},[d,g]),(0,a.useEffect)(()=>{g()},[c,g]),{sessionUser:e,user:s,conversationId:l,currentConversation:i,conversationData:u,conversationLoading:m,memberCount:x,chats:d,chatsLoading:c,connectionState:o,...S,formData:N,setFormData:j,screenHeight:r,isOverFlow:t,updateOverflow:n,containerRef:h,mainRef:v,handleSendMessage:S.handleSendMessage}})();return(0,t.jsxs)("div",{className:"w-full h-full flex flex-col bg-background",children:[(0,t.jsx)(S,{id:String(r),name:String(null==n?void 0:n.name),isGroup:(null==n?void 0:n.type)==="group",avatar:null!=(e=null==n?void 0:n.avatar)?e:"",participantCount:i,members:null==l?void 0:l.members,ownerId:null==l?void 0:l.ownerId,...(null==s?void 0:s.id)!==void 0&&{currentUserId:s.id}}),h===y.KN.CONNECTING&&(0,t.jsx)("div",{className:"px-5 py-2 bg-blue-50 border-b border-blue-200",children:(0,t.jsx)("div",{className:"text-sm text-blue-600",children:"Connecting to chat server..."})}),h===y.KN.ERROR&&(0,t.jsx)("div",{className:"px-chat-outer py-2 bg-red-50 border-b border-red-200",children:(0,t.jsx)("div",{className:"text-sm text-chat-error font-normal",children:"Connection error"})}),(0,t.jsx)(K,{ref:o,className:"flex-1 p-chat-outer",children:u?(0,t.jsx)(I,{isGroup:!0}):(0,t.jsxs)("div",{className:"space-y-0",children:[(null==s?void 0:s.id)&&c.map(e=>(0,t.jsx)(E,{message:e,isGroup:!0,userId:s.id},e.id)),(0,t.jsx)("div",{ref:d,className:"h-0"})]})}),(0,t.jsx)(O,{onSendMessage:m,isConnected:x,disabled:h===y.KN.ERROR})]})}},9677:(e,s,r)=>{Promise.resolve().then(r.bind(r,3940))}},e=>{e.O(0,[941,432,594,667,621,245,838,326,585,358],()=>e(e.s=9677)),_N_E=e.O()}]);