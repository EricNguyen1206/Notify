# Channel Creation with User Selection Feature

## Overview
Implemented a comprehensive feature for creating channels with user selection, including separate dialogs for group channels and direct messages. The feature allows users to create group channels (2-4 users) and direct messages (1 user), with smart logic to detect existing direct message channels and navigate to them instead of creating duplicates.

## Recent Updates (Latest Implementation)

### Backend Improvements for Direct Message Uniqueness
- **Email-based Channel Names**: Direct message channels now use email as the channel name instead of username
  - Ensures uniqueness since emails are unique per user
  - Prevents duplicate direct message channels between the same users
  - Backend automatically generates channel names from the other user's email

- **Enhanced Duplicate Detection**: 
  - `buildDirectChannelResponse()` now returns email as channel name for direct channels
  - `CreateChannelWithUsers()` auto-generates names for direct messages when not provided
  - Frontend can accurately detect existing channels using email comparison

### Separation of Channel Types
- **Group Channels**: Always require a name and 2-4 users (including current user)
- **Direct Messages**: No name required (auto-generated from email), select exactly 1 other user
- **Smart Duplicate Detection**: For direct messages, checks if channel already exists and navigates to it
- **Type-specific Validation**: Different validation rules for group vs direct channels

### New Components
- **CreateNewChannelDialog**: Simplified for group channels only
  - Removed channel type selection (always 'group')
  - Requires channel name input
  - Validates 2-4 users including current user
  
- **CreateNewDirectMessageDialog**: New component for direct messages
  - No name input required (auto-generated by backend from email)
  - Select exactly 1 other user
  - Detects existing direct channels and navigates instead of creating duplicates
  - Automatic redirection after creation/opening

### Enhanced Hook Logic
- **useCreateChannel**: Updated with `defaultType` parameter
  - Supports both 'group' (default) and 'direct' types
  - Type-specific validation rules
  - Automatic name generation for direct messages (handled by backend)
  - Proper user ID handling (auto-adds current user for direct messages)

### UI Improvements
- **SidebarChannels**: Added both channel creation buttons
  - Plus icon for group channels
  - MessageCircle icon for direct messages
  - Side-by-side button layout

## Backend Implementation

### Models
- **CreateChannelRequest**: Struct in `chat-service/internal/models/channel.go`
  - `name`: Channel name (required for group, auto-generated for direct from email)
  - `type`: Channel type - "group" or "direct" (required)
  - `userIds`: Array of user IDs (2-4 for group, 2 for direct including current user)

### API Endpoints
- **POST /api/v1/channels/**: Updated to handle both channel types
  - Group channels: Validates minimum 2 users, maximum 4 users
  - Direct messages: Validates exactly 2 users (current + 1 selected)
  - Auto-generates names for direct messages using email
  - Creates channel with all specified users as members

- **GET /api/v1/users/search?username=...**: User search endpoint
  - Searches users by username (partial match using ILIKE)
  - Returns filtered results for user selection
  - Limited to 10 results to prevent abuse

### Services
- **ChannelService.CreateChannelWithUsers()**: Creates channels with specified users
  - Auto-generates direct message names from user emails
  - Prevents duplicate direct message channels
- **ChannelService.buildDirectChannelResponse()**: Returns email as channel name for direct channels
- **UserService.SearchUsersByUsername()**: Searches users by username for selection

### Repositories
- **UserRepository.SearchUsersByUsername()**: Database query with ILIKE search on username field
- **UserRepository.GetFriendsByChannelID()**: Gets other users in a channel (excluding current user)

## Frontend Implementation

### Generated API Integration
- **TypeScript Client**: Fully generated from OpenAPI 3.0.1 specifications
- **API Hooks**: Uses `useGetUsersSearch` and `usePostChannels` from generated code
- **Type Safety**: All API calls use generated TypeScript interfaces
- **Schema Validation**: Automatic validation using generated schemas

### Components
- **UserSearchInput**: Reusable component for user search and selection
  - Username search with generated API hook (`useGetUsersSearch`)
  - User selection with removable badges
  - Real-time validation feedback
  - Configurable min/max user limits

- **CreateNewChannelDialog**: Enhanced for group channels only
  - Channel name input (required)
  - User search and selection interface (2-4 users)
  - Form validation and error handling
  - Fixed type: 'group'

- **CreateNewDirectMessageDialog**: New component for direct messages
  - User search and selection (exactly 1 user)
  - No name input (auto-generated by backend from email)
  - Existing channel detection and navigation using email matching
  - Fixed type: 'direct'

### Hooks
- **useCreateChannel**: Enhanced with type-specific logic
  - `defaultType` parameter for setting channel type
  - Type-specific validation (group vs direct)
  - Automatic user inclusion for direct messages
  - Backend handles name generation for better consistency
  - Uses generated `ChatServiceInternalModelsCreateChannelRequest` schema

### Features
- **Duplicate Prevention**: Detects existing direct message channels using email matching
- **Auto-navigation**: Redirects to existing or newly created channels
- **Type-specific UI**: Different interfaces for different channel types
- **Debounced search**: Reduces API calls with 300ms delay
- **Visual feedback**: Selected users with removable badges
- **Real-time validation**: Immediate feedback on form errors
- **Responsive design**: Proper error handling and user feedback

## Technical Details

### Channel Type Logic
- **Group Channels**: 
  - Require manual name input
  - Allow 2-4 users (including current user)
  - Current user must be in selection
  
- **Direct Messages**:
  - Auto-generate name from the other user's email (backend)
  - Select exactly 1 other user
  - Auto-add current user to userIds
  - Check for existing channels using email matching

### Validation Rules
- **Group Channel Validation**:
  - Name required (2-50 characters)
  - 2-4 users including current user
  - Current user must be in selection
  
- **Direct Message Validation**:
  - No name validation (auto-generated by backend from email)
  - Exactly 1 other user selected
  - Current user auto-included (not in selection)

### Duplicate Detection Logic
- **Backend**: 
  - Direct channel names are now user emails (unique identifiers)
  - `buildDirectChannelResponse()` returns email as channel name
  - `CreateChannelWithUsers()` auto-generates names from user emails
  
- **Frontend**:
  - Compares selected user's email with existing direct channel names
  - Exact email match indicates existing direct message channel
  - Prevents creation of duplicate channels

### Navigation Logic
- **New Channels**: Navigate to `/messages/[channelId]` after creation
- **Existing Direct Messages**: Navigate to existing channel without creating duplicate
- **Error Handling**: Toast notifications for success/error states

### Performance
- Debounced search (300ms) to reduce API calls
- Limited search results (10 users max)
- Efficient user filtering and state management
- React Query caching for search results
- Smart duplicate detection using email matching to prevent unnecessary API calls

## Code Quality
- All comments in English as requested
- Consistent with existing codebase patterns
- Proper error handling and user feedback
- TypeScript interfaces for type safety
- Responsive UI components
- Clean code with removed unused imports
- Full integration with generated API code
- Separated concerns between group and direct message creation
- Backend handles name generation for better consistency

## Testing
- Backend compiles successfully with Go
- Frontend builds successfully with Next.js
- API endpoints properly configured
- UI components properly integrated
- Generated code properly integrated
- Type safety maintained throughout
- Both dialog types function correctly
- Navigation logic works as expected
- Duplicate detection works accurately using email matching

## API Endpoints

### POST /api/v1/channels/
**Request Body (Group Channel):**
```json
{
  "name": "My Group Channel",
  "type": "group",
  "userIds": [1, 2, 3, 4]
}
```

**Request Body (Direct Message):**
```json
{
  "name": "", // Empty or omitted - backend will auto-generate from email
  "type": "direct",
  "userIds": [1, 2]
}
```

**Response:**
```json
{
  "data": {
    "id": 1,
    "name": "user@example.com", // Email for direct, custom name for group
    "type": "direct",
    "ownerId": 1
  }
}
```

### GET /api/v1/users/search?username=username
**Response:**
```json
[
  {
    "id": 1,
    "email": "user@example.com",
    "username": "username",
    "created_at": "2024-01-01T00:00:00Z",
    "avatar": "avatar_url"
  }
]
```

### GET /api/v1/channels/ (User Channels)
**Response:**
```json
{
  "direct": [
    {
      "id": 1,
      "name": "friend@example.com", // Email of the other user
      "avatar": "avatar_url",
      "type": "direct",
      "ownerId": 1
    }
  ],
  "group": [
    {
      "id": 2,
      "name": "My Group Channel",
      "type": "group",
      "ownerId": 1
    }
  ]
}
```

## Generated Code Structure

### Schemas
- `ChatServiceInternalModelsCreateChannelRequest`: Channel creation request
- `ChatServiceInternalModelsUserResponse`: User response model
- `ChatServiceInternalModelsCreateChannelRequestType`: Channel type enum

### API Hooks
- `useGetUsersSearch`: Search users by username
- `usePostChannels`: Create new channel
- Full TypeScript support with proper types

### Integration Points
- **UserSearchInput**: Uses `useGetUsersSearch` for search
- **useCreateChannel**: Uses `usePostChannels` for creation
- **Type Safety**: All components use generated types
- **Error Handling**: Consistent error handling across generated code

## Swagger Documentation Updates
- **DirectChannelResponse.name**: Added description explaining email usage for uniqueness
- **API Behavior**: Documents automatic name generation for direct messages
- **Response Examples**: Shows email-based naming for direct channels

## Future Enhancements
- Enhanced existing channel detection using member lists
- User avatar display in search results
- Channel template presets
- Bulk user import functionality
- Advanced search filters (email, etc.)
- Real-time user status updates
- Channel member management UI
- Direct message threading
- Enhanced duplicate detection algorithms
- Channel name customization for direct messages
